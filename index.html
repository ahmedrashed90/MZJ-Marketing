
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MZJ — مولد خطة النشر</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Libraries -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --brown: rgb(62,36,32);
      --beige: rgb(188,143,116);
      --cream: #fff8ef;
      --card: rgba(255,255,255,.55);
      --line: rgba(62,36,32,.14);
      --text: #2b201e;
      --muted: rgba(43,32,30,.65);
      --shadow: 0 18px 55px rgba(62,36,32,.12);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Tajawal", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(188,143,116,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(62,36,32,.16), transparent 55%),
        linear-gradient(180deg, #fff3e6, var(--cream));
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }
    /* mouse glow */
    .glow{
      position:fixed; inset:-200px;
      pointer-events:none;
      background: radial-gradient(320px 320px at var(--mx,50%) var(--my,50%), rgba(188,143,116,.22), transparent 60%);
      filter: blur(1px);
      z-index:0;
    }
    .wrap{position:relative; z-index:1; max-width:1100px; margin:26px auto; padding:0 18px 40px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.45));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: 22px;
      padding:16px 18px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .logo{
      width:44px; height:44px; border-radius:16px;
      background: radial-gradient(80% 80% at 25% 20%, rgba(255,255,255,.45), transparent 60%), linear-gradient(135deg, var(--beige), var(--brown));
      box-shadow: 0 10px 22px rgba(62,36,32,.22);
    }
    .ttl{font-weight:800; color:var(--brown); font-size:18px; margin:0}
    .sub{margin:2px 0 0; color:var(--muted); font-size:13px; line-height:1.4; max-width:560px}
    .fb{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      border-radius: 16px;
      min-width:220px;
      justify-content:space-between;
    }
    .dot{width:10px; height:10px; border-radius:50%; background:#d1b3a5; box-shadow:0 0 0 3px rgba(188,143,116,.18)}
    .fb b{font-weight:800; color:var(--brown)}
    .fb small{color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .fb{min-width:unset; width:100%}
      .top{flex-direction:column; align-items:stretch}
    }
    .card{
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.42));
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
      color:var(--brown);
      letter-spacing:.2px;
    }
    .hint{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{flex:1; min-width:160px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select, input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: rgba(255,255,255,.75);
      font-family: inherit;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(188,143,116,.85); box-shadow: 0 0 0 4px rgba(188,143,116,.18)}
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      font-family: inherit;
      font-weight:800;
      color:var(--brown);
      box-shadow: 0 10px 26px rgba(62,36,32,.10);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 14px 30px rgba(62,36,32,.14)}
    .btn.primary{
      border-color: rgba(188,143,116,.55);
      background: linear-gradient(135deg, rgba(188,143,116,.30), rgba(255,255,255,.65));
    }
    .picker{
      display:none;
      margin-top:12px;
      border:1px solid rgba(62,36,32,.16);
      background: rgba(255,255,255,.55);
      border-radius: 18px;
      padding:12px;
    }
    .picker.open{display:block}
    .pickerHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .pickerHead b{color:var(--brown)}
    .list{
      max-height: 240px;
      overflow:auto;
      padding:6px;
      border-radius: 14px;
      border:1px dashed rgba(62,36,32,.18);
      background: rgba(255,255,255,.55);
    }
    .item{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(62,36,32,.10);
      margin-bottom:8px;
    }
    .chipWrap{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(188,143,116,.20);
      border:1px solid rgba(188,143,116,.35);
      color:var(--brown);
      font-weight:800;
      font-size:13px;
    }
    .chip button{
      border:none; background:transparent; cursor:pointer;
      color:rgba(62,36,32,.75); font-weight:900; font-size:14px;
    }
    .mini{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
      margin-top:10px;
    }
    .mini .field{min-width:220px}
    .toast{
      position: fixed; left:18px; bottom:18px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.16);
      background: rgba(255,255,255,.85);
      box-shadow: 0 16px 40px rgba(62,36,32,.14);
      color:var(--brown);
      font-weight:800;
      display:none;
      z-index:5;
    }
  </style>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUniCf_A3fyZHbUN0REKhrFwhjYbojWIc",
      authDomain: "mzj-content-planner.firebaseapp.com",
      projectId: "mzj-content-planner",
      storageBucket: "mzj-content-planner.firebasestorage.app",
      messagingSenderId: "702048592652",
      appId: "1:702048592652:web:9b3377dacbe4c98b339f29",
      measurementId: "G-J77RGXSL4R"
    };

    try{
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const ref = doc(db, 'settings', 'content-planner');

      async function ping(){
        await getDoc(ref);
        await setDoc(ref, { lastPing: serverTimestamp() }, { merge: true });
        return true;
      }

      window.__fbReady = Promise.resolve({ db, ref, getDoc, setDoc, serverTimestamp, ping });
      console.log('Firebase ready ✅');
    }catch(e){
      window.__fbReady = Promise.reject(e);
      console.error('Firebase init failed ❌', e);
    }
  </script>

</head>

<body>
  <div class="glow" id="glow"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <p class="ttl">MZJ — مولد خطة النشر</p>
          <p class="sub">اختار الشهر والسنة وعدد أيام النشر والمنصات وأنواع المحتوى. بعدين حمّل الشيت والسكربت (ويندوز) لإنشاء الفولدرات تلقائيًا.</p>
        </div>
      </div>

      <div class="fb" title="الاتصال بـ Firestore (اختياري)">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="dot" id="fbDot"></span>
          <div>
            <b>Firebase</b><br>
            <small id="fbText">جاري الاتصال…</small>
          </div>
        </div>
        <button class="btn" type="button" id="fbBtn">تحديث من Firebase</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>إعدادات الفترة</h2>
        <p class="hint">اختار الشهر والسنة وعدد أيام النشر. يوم الجمعة يولّد تلقائيًا "جمعة مباركة".</p>

        <div class="row">
          <div class="field">
            <label>السنة</label>
            <select id="yearSel"></select>
          </div>
          <div class="field">
            <label>الشهر</label>
            <select id="monthSel"></select>
          </div>
          <div class="field">
            <label>عدد أيام النشر</label>
            <input id="publishDays" inputmode="numeric" placeholder="مثال: 13" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>مخرجات التحميل</h2>
        <p class="hint">الشيت فيه (اليوم/المنصات/نوع المحتوى/اسم السيارة). السكربت ويندوز يقرأ الشيت ويعمل الفولدرات على جهازك.</p>
        <div class="row">
          <button class="btn primary" id="downloadExcelBtn" type="button">تحميل الشيت (Excel)</button>
          <button class="btn" id="downloadWinZipBtn" type="button">تحميل سكربت ويندوز (ZIP)</button>
        </div>
        <div class="mini">
          <div class="field">
            <label>ملاحظة التشغيل</label>
            <input disabled value="فك الـ ZIP → سمّي الشيت plan.xlsx → شغّل RUN.bat → المخرجات داخل OUTPUT" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>المنصات</h2>
        <p class="hint">اختار المنصات مرة واحدة، وكل منصة تختارها تتحول Chip وتختفي من القائمة.</p>

        <button class="btn" type="button" id="openPlatformsBtn">اختيار المنصات</button>

        <div class="picker" id="platformPicker">
          <div class="pickerHead">
            <b>اختيار المنصات</b>
            <button class="btn" type="button" id="closePlatformsBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة منصة مخصصة</label>
              <input id="platformCustom" placeholder="مثال: Threads" />
            </div>
            <button class="btn" type="button" id="addPlatformBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>المنصات المتاحة</label>
            <div class="list" id="platformList"></div>
          </div>
        </div>

        <div class="chipWrap" id="platformChips"></div>
      </div>

      <div class="card">
        <h2>أنواع المحتوى</h2>
        <p class="hint">اختار أنواع المحتوى مرة واحدة (صورة/ريل مواصفات/فيديو قصير... إلخ).</p>

        <button class="btn" type="button" id="openTypesBtn">اختيار أنواع المحتوى</button>

        <div class="picker" id="typePicker">
          <div class="pickerHead">
            <b>اختيار أنواع المحتوى</b>
            <button class="btn" type="button" id="closeTypesBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة نوع مخصص</label>
              <input id="typeCustom" placeholder="مثال: لايف" />
            </div>
            <button class="btn" type="button" id="addTypeBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>الأنواع المتاحة</label>
            <div class="list" id="typeList"></div>
          </div>
        </div>

        <div class="chipWrap" id="typeChips"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  // mouse glow
  const glow = document.getElementById('glow');
  window.addEventListener('mousemove', (e)=>{
    const x = (e.clientX / window.innerWidth) * 100;
    const y = (e.clientY / window.innerHeight) * 100;
    glow.style.setProperty('--mx', x + '%');
    glow.style.setProperty('--my', y + '%');
  });

  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toastEl.style.display='none', 2200);
  }

  // period
  const yearSel = $('yearSel');
  const monthSel = $('monthSel');
  const publishDays = $('publishDays');

  const monthsAr = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  const now = new Date();
  const yNow = now.getFullYear();

  for(let y=yNow-1; y<=yNow+3; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    if(y===yNow) opt.selected = true;
    yearSel.appendChild(opt);
  }
  monthsAr.forEach((m, i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = m;
    if(i===now.getMonth()) opt.selected = true;
    monthSel.appendChild(opt);
  });

  // selection engine
  const DEFAULT_PLATFORMS = ['Instagram','TikTok','Snapchat','Facebook','X (Twitter)'];
  const DEFAULT_TYPES = ['بوست صورة','ريل مواصفات','فيديو قصير'];

  let availablePlatforms = [...DEFAULT_PLATFORMS];
  let selectedPlatforms = [];

  let availableTypes = [...DEFAULT_TYPES];
  let selectedTypes = [];

  function renderList(listEl, items, selectedArr, onToggle){
    listEl.innerHTML = '';
    if(items.length===0){
      listEl.innerHTML = '<div style="padding:10px;color:rgba(43,32,30,.6)">مفيش عناصر متاحة</div>';
      return;
    }
    items.forEach(name=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `<span style="font-weight:800;color:var(--brown)">${name}</span>
                       <button class="btn" type="button" style="padding:8px 10px">إضافة</button>`;
      row.querySelector('button').addEventListener('click', ()=>onToggle(name));
      listEl.appendChild(row);
    });
  }

  function renderChips(chipsEl, selectedArr, onRemove){
    chipsEl.innerHTML = '';
    selectedArr.forEach(name=>{
      const c = document.createElement('span');
      c.className = 'chip';
      c.innerHTML = `<span>${name}</span><button type="button" aria-label="remove">×</button>`;
      c.querySelector('button').addEventListener('click', ()=>onRemove(name));
      chipsEl.appendChild(c);
    });
  }

  function pickPlatform(name){
    selectedPlatforms.push(name);
    availablePlatforms = availablePlatforms.filter(x=>x!==name);
    renderAllPlatforms();
  }
  function removePlatform(name){
    selectedPlatforms = selectedPlatforms.filter(x=>x!==name);
    if(!availablePlatforms.includes(name)) availablePlatforms.push(name);
    availablePlatforms.sort((a,b)=>a.localeCompare(b));
    renderAllPlatforms();
  }
  function renderAllPlatforms(){
    renderList($('platformList'), availablePlatforms, selectedPlatforms, pickPlatform);
    renderChips($('platformChips'), selectedPlatforms, removePlatform);
  }

  function pickType(name){
    selectedTypes.push(name);
    availableTypes = availableTypes.filter(x=>x!==name);
    renderAllTypes();
  }
  function removeType(name){
    selectedTypes = selectedTypes.filter(x=>x!==name);
    if(!availableTypes.includes(name)) availableTypes.push(name);
    availableTypes.sort((a,b)=>a.localeCompare(b));
    renderAllTypes();
  }
  function renderAllTypes(){
    renderList($('typeList'), availableTypes, selectedTypes, pickType);
    renderChips($('typeChips'), selectedTypes, removeType);
  }

  renderAllPlatforms();
  renderAllTypes();

  // picker open/close
  $('openPlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.add('open'));
  $('closePlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.remove('open'));
  $('openTypesBtn').addEventListener('click', ()=> $('typePicker').classList.add('open'));
  $('closeTypesBtn').addEventListener('click', ()=> $('typePicker').classList.remove('open'));

  // add custom platform/type
  $('addPlatformBtn').addEventListener('click', ()=>{
    const v = ($('platformCustom').value||'').trim();
    if(!v) return;
    if(selectedPlatforms.includes(v) || availablePlatforms.includes(v)) { toast('الموجود بالفعل'); return; }
    availablePlatforms.unshift(v);
    $('platformCustom').value = '';
    renderAllPlatforms();
  });
  $('addTypeBtn').addEventListener('click', ()=>{
    const v = ($('typeCustom').value||'').trim();
    if(!v) return;
    if(selectedTypes.includes(v) || availableTypes.includes(v)) { toast('الموجود بالفعل'); return; }
    availableTypes.unshift(v);
    $('typeCustom').value = '';
    renderAllTypes();
  });

  function buildPlanRows(){
    const year = Number(yearSel.value);
    const monthIndex0 = Number(monthSel.value);
    const daysN = Math.max(0, Number((publishDays.value||'').trim()) || 0);

    const rows = [];
    for(let d=1; d<=daysN; d++){
      const date = new Date(year, monthIndex0, d);
      const iso = date.toISOString().slice(0,10);
      const isFriday = date.getDay() === 5;

      rows.push({
        "اليوم": iso,
        "المنصات": selectedPlatforms.join(', '),
        "نوع المحتوى": selectedTypes.join(', '),
        "اسم السيارة": isFriday ? 'جمعة مباركة' : ''
      });
    }
    return rows;
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }

  async function downloadExcel(){
    if(typeof XLSX === 'undefined'){
      toast('XLSX مش محمّل');
      return;
    }
    if(!publishDays.value.trim()){
      toast('اكتب عدد أيام النشر');
      return;
    }
    const rows = buildPlanRows();
    const ws = XLSX.utils.json_to_sheet(rows, { header: ["اليوم","المنصات","نوع المحتوى","اسم السيارة"] });
    ws['!cols'] = [{wch:14},{wch:36},{wch:36},{wch:40}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Plan');

    const year = Number(yearSel.value);
    const monthNum = String(Number(monthSel.value)+1).padStart(2,'0');
    const file = `MZJ-Plan-${year}-${monthNum}.xlsx`;

    const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    downloadBlob(new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), file);
  }

  const builderJs = `const fs = require('fs');
const path = require('path');
const XLSX = require('xlsx');

function safeName(s){
  return String(s||'').trim().replace(/[\\\\/:*?\\"<>|]/g,'-').replace(/\\s+/g,' ').trim();
}
function ensureDir(p){ if(!fs.existsSync(p)) fs.mkdirSync(p,{recursive:true}); }
function splitList(s){ return String(s||'').split(',').map(x=>x.trim()).filter(Boolean); }
function typeFolders(typeName){
  const t = (typeName||'').toLowerCase();
  if(t.includes('صورة') || t.includes('بوست')) return ['صور','ستوري'];
  if(t.includes('مواصفات')) return ['ريل مواصفات'];
  if(t.includes('فيديو') || t.includes('قصير')) return ['فيديو قصير'];
  if(t.includes('جمعة')) return ['صور','ستوري'];
  return [safeName(typeName)];
}

const root = path.join(__dirname,'OUTPUT');
const planPath = path.join(__dirname,'plan.xlsx');

if(!fs.existsSync(planPath)){
  console.error('Missing plan.xlsx (ضع ملف الشيت باسم plan.xlsx داخل نفس المجلد).');
  process.exit(1);
}

const wb = XLSX.readFile(planPath);
const ws = wb.Sheets[wb.SheetNames[0]];
const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

ensureDir(root);

for(const r of rows){
  const day = safeName(r['اليوم'] || '');
  if(!day) continue;

  const platforms = splitList(r['المنصات'] || '');
  const types = splitList(r['نوع المحتوى'] || '');
  const car = safeName(r['اسم السيارة'] || '');

  const isFridayPost = (car === 'جمعة مباركة');

  if(isFridayPost){
    const base = path.join(root, day, 'جمعة مباركة');
    ensureDir(path.join(base,'صور'));
    ensureDir(path.join(base,'ستوري'));
    continue;
  }

  for(const p of (platforms.length ? platforms : ['Platform'])){
    const platBase = path.join(root, day, safeName(p));
    for(const t of (types.length ? types : ['نوع المحتوى'])){
      const folders = typeFolders(t);
      for(const f of folders){
        const target = path.join(platBase, f, car || 'اسم السيارة');
        ensureDir(target);
      }
    }
  }
}

console.log('Done ✅  Created folders in OUTPUT');`;

  async function downloadWinZip(){
    if(typeof JSZip === 'undefined'){
      toast('JSZip مش محمّل');
      return;
    }
    const zip = new JSZip();
    const packageJson = {
      name: "mzj-folder-builder",
      version: "1.0.0",
      private: true,
      type: "commonjs",
      scripts: { start: "node build-folders.js" },
      dependencies: { xlsx: "^0.18.5" }
    };
    const readme = `تشغيل سكربت إنشاء الفولدرات (ويندوز)\r\n\r\n1) فك الضغط\r\n2) ضع ملف الشيت باسم plan.xlsx داخل نفس المجلد\r\n3) دبل كليك RUN.bat\r\n\r\nالمخرجات:\r\nOUTPUT\\YYYY-MM-DD\\Platform\\(صور/ستوري/ريل مواصفات/فيديو قصير)\\اسم السيارة\r\nويوم الجمعة:\r\nOUTPUT\\YYYY-MM-DD\\جمعة مباركة\\(صور/ستوري)\r\n`;
    const bat = `@echo off\r\nsetlocal\r\ncd /d %~dp0\r\necho Installing dependencies...\r\nnpm install\r\nif %errorlevel% neq 0 (\r\n  echo npm install failed.\r\n  pause\r\n  exit /b 1\r\n)\r\necho Running...\r\nnode build-folders.js\r\npause\r\n`;

    zip.file("package.json", JSON.stringify(packageJson, null, 2));
    zip.file("build-folders.js", builderJs);
    zip.file("RUN.bat", bat);
    zip.file("README_AR.txt", readme);

    const blob = await zip.generateAsync({type:'blob'});
    downloadBlob(blob, 'mzj-folder-builder-win.zip');
  }

  
  // ---------------- Firebase (optional) ----------------
  const fbDot = $('fbDot');
  const fbText = $('fbText');
  const fbBtn = $('fbBtn');

  function setFb(state, text){
    if(state === 'ok'){
      fbDot.style.background = '#2bb673';
      fbDot.style.boxShadow = '0 0 0 3px rgba(43,182,115,.18)';
    }else if(state === 'bad'){
      fbDot.style.background = '#e44';
      fbDot.style.boxShadow = '0 0 0 3px rgba(228,68,68,.18)';
    }else{
      fbDot.style.background = '#d1b3a5';
      fbDot.style.boxShadow = '0 0 0 3px rgba(188,143,116,.18)';
    }
    fbText.textContent = text;
  }

  async function fbInit(){
    setFb('mid','جاري الاتصال…');
    try{
      const fb = await window.__fbReady;
      await fb.ping();
      setFb('ok','متصل ✅');
      fbBtn.disabled = false;
      await fbLoad();
    }catch(e){
      console.error('Firebase error', e);
      setFb('bad','غير متصل');
      fbBtn.disabled = true;
    }
  }

  async function fbLoad(){
    try{
      const fb = await window.__fbReady;
      const snap = await fb.getDoc(fb.ref);
      if(snap.exists()){
        const d = snap.data() || {};

        if(Array.isArray(d.platforms)){
          selectedPlatforms = d.platforms.slice();
          availablePlatforms = [...DEFAULT_PLATFORMS].filter(x=>!selectedPlatforms.includes(x));
          renderAllPlatforms();
        }
        if(Array.isArray(d.contentTypes)){
          selectedTypes = d.contentTypes.slice();
          availableTypes = [...DEFAULT_TYPES].filter(x=>!selectedTypes.includes(x));
          renderAllTypes();
        }
        if(typeof d.publishDays === 'number') publishDays.value = String(d.publishDays || '');
        if(typeof d.year === 'number') yearSel.value = String(d.year);
        if(typeof d.monthIndex0 === 'number') monthSel.value = String(d.monthIndex0);

        toast('تم تحميل الإعدادات من Firebase');
      }else{
        await fbSave(true);
      }
    }catch(e){
      console.error('fbLoad', e);
    }
  }

  let __saveTimer = null;
  function fbScheduleSave(){
    clearTimeout(__saveTimer);
    __saveTimer = setTimeout(()=>fbSave(false), 450);
  }

  async function fbSave(isSeed){
    try{
      const fb = await window.__fbReady;
      const payload = {
        platforms: selectedPlatforms,
        contentTypes: selectedTypes,
        publishDays: Math.max(0, Number((publishDays.value||'').trim()) || 0),
        year: Number(yearSel.value),
        monthIndex0: Number(monthSel.value),
        updatedAt: fb.serverTimestamp()
      };
      if(isSeed) payload.createdAt = fb.serverTimestamp();
      await fb.setDoc(fb.ref, payload, { merge: true });
    }catch(e){
      // silent
    }
  }

  fbBtn?.addEventListener('click', fbLoad);

  yearSel.addEventListener('change', fbScheduleSave);
  monthSel.addEventListener('change', fbScheduleSave);
  publishDays.addEventListener('input', fbScheduleSave);

  // wrap selection mutators to auto-save
  const __pickPlatform = pickPlatform;
  pickPlatform = function(name){ __pickPlatform(name); fbScheduleSave(); };
  const __removePlatform = removePlatform;
  removePlatform = function(name){ __removePlatform(name); fbScheduleSave(); };

  const __pickType = pickType;
  pickType = function(name){ __pickType(name); fbScheduleSave(); };
  const __removeType = removeType;
  removeType = function(name){ __removeType(name); fbScheduleSave(); };

  // init
  fbInit();

$('downloadExcelBtn').addEventListener('click', downloadExcel);
  $('downloadWinZipBtn').addEventListener('click', downloadWinZip);
</script>
</body>
</html>
