


<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MZJ — مولد خطة النشر</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Libs (defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --brown: rgb(62,36,32);
      --beige: rgb(188,143,116);
      --cream: #fff8ef;
      --line: rgba(62,36,32,.14);
      --text: #2b201e;
      --muted: rgba(43,32,30,.65);
      --shadow: 0 18px 55px rgba(62,36,32,.12);
      --r: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(188,143,116,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(62,36,32,.16), transparent 55%),
        linear-gradient(180deg, #fff3e6, var(--cream));
      overflow-x:hidden;
    }
    .glow{
      position:fixed; inset:-200px; pointer-events:none; z-index:0;
      background: radial-gradient(340px 340px at var(--mx,50%) var(--my,50%), rgba(188,143,116,.22), transparent 60%);
      filter: blur(1px);
    }
    .wrap{position:relative; z-index:1; max-width:1180px; margin:26px auto; padding:0 18px 42px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.45));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--r);
      padding:16px 18px;
      margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:44px; height:44px; border-radius:16px;
      background:
        radial-gradient(80% 80% at 25% 20%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, var(--beige), var(--brown));
      box-shadow: 0 10px 22px rgba(62,36,32,.22);
      flex:0 0 auto;
    }
    .ttl{margin:0; font-weight:900; color:var(--brown); font-size:18px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width:640px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .top{flex-direction:column; align-items:stretch}
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.42));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px; font-size:16px; font-weight:900; color:var(--brown)}
    .hint{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{flex:1; min-width:180px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select, input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: rgba(255,255,255,.78);
      font-family: inherit;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(188,143,116,.85); box-shadow: 0 0 0 4px rgba(188,143,116,.18)}
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: linear-gradient(135deg, rgba(255,255,255,.78), rgba(255,255,255,.55));
      font-family: inherit;
      font-weight:900;
      color:var(--brown);
      box-shadow: 0 10px 26px rgba(62,36,32,.10);
      transition: transform .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 14px 30px rgba(62,36,32,.14)}
    .btn.primary{
      border-color: rgba(188,143,116,.55);
      background: linear-gradient(135deg, rgba(188,143,116,.28), rgba(255,255,255,.70));
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .picker{display:none; margin-top:12px; border:1px solid rgba(62,36,32,.16); background: rgba(255,255,255,.55); border-radius: 18px; padding:12px;}
    .picker.open{display:block}
    .pickerHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .pickerHead b{color:var(--brown)}
    .list{max-height: 240px; overflow:auto; padding:6px; border-radius: 14px; border:1px dashed rgba(62,36,32,.18); background: rgba(255,255,255,.55);}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 10px; border-radius: 12px; background: rgba(255,255,255,.65); border:1px solid rgba(62,36,32,.10); margin-bottom:8px;}
    .chipWrap{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 999px; background: rgba(188,143,116,.20); border:1px solid rgba(188,143,116,.35); color:var(--brown); font-weight:900; font-size:13px;}
    .chip button{border:none; background:transparent; cursor:pointer; color:rgba(62,36,32,.75); font-weight:900; font-size:16px; line-height:1}
    .mini{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;}
    .toast{
      position: fixed; left:18px; bottom:18px; z-index:10;
      padding:12px 14px; border-radius: 14px;
      border:1px solid rgba(62,36,32,.16);
      background: rgba(255,255,255,.88);
      box-shadow: 0 16px 40px rgba(62,36,32,.14);
      color:var(--brown);
      font-weight:900;
      display:none;
      max-width:min(420px, calc(100vw - 36px));
    }
    /* preview modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(20,10,8,.35);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:20;
      backdrop-filter: blur(2px);
    }
    .modalBack.open{display:flex}
    .modal{
      width:min(980px, 100%);
      max-height:min(85vh, 760px);
      overflow:auto;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(62,36,32,.18);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      padding:14px;
    }
    .modalTop{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .modalTop b{color:var(--brown); font-size:15px}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid rgba(62,36,32,.16)}
    th, td{padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(62,36,32,.10); vertical-align:top}
    th{background: rgba(188,143,116,.18); color:var(--brown); font-weight:900; position:sticky; top:0}
    tr:last-child td{border-bottom:none}
    td{background: rgba(255,255,255,.65)}
  </style>
</head>

<body>
  <div class="glow" id="glow"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <p class="ttl">MZJ — مولد خطة النشر</p>
          <p class="sub">اختار الشهر والسنة وعدد أيام النشر والمنصات وأنواع المحتوى. بعدين حمّل الشيت والسكربت (ويندوز) لإنشاء الفولدرات تلقائيًا على جهازك.</p>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>إعدادات الفترة</h2>
        <p class="hint">اختار الشهر والسنة وعدد أيام النشر. يوم الجمعة يولّد تلقائيًا "جمعة مباركة".</p>
        <div class="row">
          <div class="field">
            <label>السنة</label>
            <select id="yearSel"></select>
          </div>
          <div class="field">
            <label>الشهر</label>
            <select id="monthSel"></select>
          </div>
          <div class="field">
            <label>عدد أيام النشر</label>
            <input id="publishDays" inputmode="numeric" placeholder="مثال: 13" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>مخرجات التحميل</h2>
        <p class="hint">الشيت فيه (اليوم/المنصات + عمود لكل نوع محتوى + مناسبة). السكربت (ويندوز) يقرأ الشيت ويعمل الفولدرات داخل OUTPUT.</p>
        <div class="row">
          <button class="btn primary" id="downloadExcelBtn" type="button">تحميل الشيت (Excel)</button>
          <button class="btn" id="downloadWinZipBtn" type="button">تحميل سكربت ويندوز (ZIP)</button>
          <button class="btn" id="previewBtn" type="button">معاينة</button>
        </div>
        <div class="mini">
          <div class="field" style="min-width:320px">
            <label>ملاحظة التشغيل</label>
            <input disabled value="فك الـ ZIP → سمّي الشيت plan.xlsx → شغّل RUN.bat → المخرجات داخل OUTPUT" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>المنصات</h2>
        <p class="hint">اختار المنصات مرة واحدة، وكل منصة تختارها تتحول Chip وتختفي من القائمة.</p>

        <button class="btn" type="button" id="openPlatformsBtn">اختيار المنصات</button>

        <div class="picker" id="platformPicker">
          <div class="pickerHead">
            <b>اختيار المنصات</b>
            <button class="btn" type="button" id="closePlatformsBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة منصة مخصصة</label>
              <input id="platformCustom" placeholder="مثال: Threads" />
            </div>
            <button class="btn" type="button" id="addPlatformBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>المنصات المتاحة</label>
            <div class="list" id="platformList"></div>
          </div>
        </div>

        <div class="chipWrap" id="platformChips"></div>
      </div>

      <div class="card">
        <h2>أنواع المحتوى</h2>
        <p class="hint">اختار أنواع المحتوى مرة واحدة (بوست صورة/ريل مواصفات/فيديو قصير… إلخ).</p>

        <button class="btn" type="button" id="openTypesBtn">اختيار أنواع المحتوى</button>

        <div class="picker" id="typePicker">
          <div class="pickerHead">
            <b>اختيار أنواع المحتوى</b>
            <button class="btn" type="button" id="closeTypesBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة نوع مخصص</label>
              <input id="typeCustom" placeholder="مثال: لايف" />
            </div>
            <button class="btn" type="button" id="addTypeBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>الأنواع المتاحة</label>
            <div class="list" id="typeList"></div>
          </div>
        </div>

        <div class="chipWrap" id="typeChips"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <b id="previewTitle">معاينة</b>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn" id="closePreviewBtn" type="button">إغلاق</button>
        </div>
      </div>
      <div id="previewBody"></div>
    </div>
  </div>

<script>
(() => {
  const glow = document.getElementById('glow');
  window.addEventListener('mousemove', (e)=>{
    const x = (e.clientX / window.innerWidth) * 100;
    const y = (e.clientY / window.innerHeight) * 100;
    glow.style.setProperty('--mx', x + '%');
    glow.style.setProperty('--my', y + '%');
  });

  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toastEl.style.display='none', 2200);
  }

  // Period
  const yearSel = $('yearSel');
  const monthSel = $('monthSel');
  const publishDays = $('publishDays');

  const monthsAr = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  const now = new Date();
  const yNow = now.getFullYear();

  for(let y=yNow-1; y<=yNow+3; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    if(y===yNow) opt.selected = true;
    yearSel.appendChild(opt);
  }
  monthsAr.forEach((m, i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = m;
    if(i===now.getMonth()) opt.selected = true;
    monthSel.appendChild(opt);
  });

  // Pickers
  const DEFAULT_PLATFORMS = ['Instagram','TikTok','Snapchat','Facebook','X (Twitter)'];
  const DEFAULT_TYPES = ['بوست صورة','ريل مواصفات','فيديو قصير'];

  let availablePlatforms = [...DEFAULT_PLATFORMS];
  let selectedPlatforms = [];

  let availableTypes = [...DEFAULT_TYPES];
  let selectedTypes = [];

  function renderList(listEl, items, onAdd){
    listEl.innerHTML = '';
    if(items.length===0){
      listEl.innerHTML = '<div style="padding:10px;color:rgba(43,32,30,.6)">مفيش عناصر متاحة</div>';
      return;
    }
    items.forEach(name=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `<span style="font-weight:900;color:var(--brown)">${name}</span>
                       <button class="btn" type="button" style="padding:8px 10px">إضافة</button>`;
      row.querySelector('button').addEventListener('click', ()=>onAdd(name));
      listEl.appendChild(row);
    });
  }

  function renderChips(chipsEl, selectedArr, onRemove){
    chipsEl.innerHTML = '';
    selectedArr.forEach(name=>{
      const c = document.createElement('span');
      c.className = 'chip';
      c.innerHTML = `<span>${name}</span><button type="button" aria-label="remove">×</button>`;
      c.querySelector('button').addEventListener('click', ()=>onRemove(name));
      chipsEl.appendChild(c);
    });
  }

  function pickPlatform(name){
    selectedPlatforms.push(name);
    availablePlatforms = availablePlatforms.filter(x=>x!==name);
    renderAllPlatforms();
  }
  function removePlatform(name){
    selectedPlatforms = selectedPlatforms.filter(x=>x!==name);
    if(!availablePlatforms.includes(name)) availablePlatforms.push(name);
    availablePlatforms.sort((a,b)=>a.localeCompare(b));
    renderAllPlatforms();
  }
  function renderAllPlatforms(){
    renderList($('platformList'), availablePlatforms, pickPlatform);
    renderChips($('platformChips'), selectedPlatforms, removePlatform);
  }

  function pickType(name){
    selectedTypes.push(name);
    availableTypes = availableTypes.filter(x=>x!==name);
    renderAllTypes();
  }
  function removeType(name){
    selectedTypes = selectedTypes.filter(x=>x!==name);
    if(!availableTypes.includes(name)) availableTypes.push(name);
    availableTypes.sort((a,b)=>a.localeCompare(b));
    renderAllTypes();
  }
  function renderAllTypes(){
    renderList($('typeList'), availableTypes, pickType);
    renderChips($('typeChips'), selectedTypes, removeType);
  }

  renderAllPlatforms();
  renderAllTypes();

  $('openPlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.add('open'));
  $('closePlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.remove('open'));
  $('openTypesBtn').addEventListener('click', ()=> $('typePicker').classList.add('open'));
  $('closeTypesBtn').addEventListener('click', ()=> $('typePicker').classList.remove('open'));

  $('addPlatformBtn').addEventListener('click', ()=>{
    const v = ($('platformCustom').value||'').trim();
    if(!v) return;
    if(selectedPlatforms.includes(v) || availablePlatforms.includes(v)) { toast('الموجود بالفعل'); return; }
    availablePlatforms.unshift(v);
    $('platformCustom').value = '';
    renderAllPlatforms();
  });

  $('addTypeBtn').addEventListener('click', ()=>{
    const v = ($('typeCustom').value||'').trim();
    if(!v) return;
    if(selectedTypes.includes(v) || availableTypes.includes(v)) { toast('الموجود بالفعل'); return; }
    availableTypes.unshift(v);
    $('typeCustom').value = '';
    renderAllTypes();
  });

  function buildPlanRows(){
    const year = Number(yearSel.value);
    const monthIndex0 = Number(monthSel.value);
    const daysN = Math.max(0, Number((publishDays.value||'').trim()) || 0);

    const typeCols = selectedTypes.slice(); // column names as-is
    const rows = [];

    // Iterate calendar days until we collect daysN rows (Friday INCLUDED in the count)
    const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
    let added = 0;

    for(let d=1; d<=daysInMonth && added < daysN; d++){
      const date = new Date(year, monthIndex0, d);

      // Local ISO (avoid UTC shift that can turn 2026-01-01 into 2025-12-31)
      const iso =
        date.getFullYear() + '-' +
        String(date.getMonth() + 1).padStart(2, '0') + '-' +
        String(date.getDate()).padStart(2, '0');

      const isFriday = date.getDay() === 5;

      const row = {
        "اليوم": iso,
        "المنصات": selectedPlatforms.join(', ')
      };

      // one column per content type (you will fill car names later)
      typeCols.forEach(t => { row[t] = ""; });

      // Friday marker (folders: جمعة مباركة -> صور + ستوري)
      row["مناسبة"] = isFriday ? "جمعة مباركة" : "";

      rows.push(row);
      added++;
    }

    return { rows, typeCols };
  }




  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }

  function requireBasics(){
    if(!publishDays.value.trim()){
      toast('اكتب عدد أيام النشر');
      return false;
    }
    if(selectedPlatforms.length === 0){
      toast('اختار منصة واحدة على الأقل');
      return false;
    }
    if(selectedTypes.length === 0){
      toast('اختار نوع محتوى واحد على الأقل');
      return false;
    }
    return true;
  }

  async function downloadExcel(){
    if(typeof XLSX === 'undefined'){
      alert('مكتبة XLSX لم تُحمّل. جرّب تعطيل AdBlock ثم حدّث الصفحة.');
      return;
    }
    if(!requireBasics()) return;

    const built = buildPlanRows();
    const rows = built.rows;
    const typeCols = built.typeCols;

    const headers = ["اليوم","المنصات", ...typeCols, "مناسبة"];
    const ws = XLSX.utils.json_to_sheet(rows, { header: headers });

    // widths
    const cols = [{wch:14},{wch:44}];
    for(let i=0;i<typeCols.length;i++) cols.push({wch:26});
    cols.push({wch:18}); // مناسبة
    ws['!cols'] = cols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Plan');

    const year = Number(yearSel.value);
    const monthNum = String(Number(monthSel.value)+1).padStart(2,'0');
    const file = `MZJ-Plan-${year}-${monthNum}.xlsx`;

    const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    downloadBlob(new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), file);
  }

  const b64ToUtf8 = (b64) => new TextDecoder('utf-8').decode(Uint8Array.from(atob(b64), c => c.charCodeAt(0)));
    const builderJs = b64ToUtf8('Y29uc3QgZnMgPSByZXF1aXJlKCdmcycpOwpjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpOwpjb25zdCBYTFNYID0gcmVxdWlyZSgneGxzeCcpOwoKY29uc29sZS5sb2coIiMjIyBNWkogQ09QWSBNT0RFIHYyIChtYW51YWwgY29weSkgbG9hZGVkICMjIyIpOwpwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlKT0+eyBjb25zb2xlLmVycm9yKCJVTkNBVUdIVDoiLCBlKTsgcHJvY2Vzcy5leGl0KDEpOyB9KTsKCmZ1bmN0aW9uIHNhZmVOYW1lKHMpewogIHJldHVybiBTdHJpbmcoc3x8JycpLnRyaW0oKQogICAgLnJlcGxhY2UoL1tcXC86Kj8iPD58XS9nLCctJykKICAgIC5yZXBsYWNlKC9ccysvZywnICcpCiAgICAudHJpbSgpOwp9CmZ1bmN0aW9uIGVuc3VyZURpcihwKXsgaWYoIWZzLmV4aXN0c1N5bmMocCkpIGZzLm1rZGlyU3luYyhwLHtyZWN1cnNpdmU6dHJ1ZX0pOyB9CmZ1bmN0aW9uIHNwbGl0TGlzdChzKXsgcmV0dXJuIFN0cmluZyhzfHwnJykuc3BsaXQoJywnKS5tYXAoeD0+eC50cmltKCkpLmZpbHRlcihCb29sZWFuKTsgfQpmdW5jdGlvbiBleGlzdHMocCl7IHRyeXsgcmV0dXJuIGZzLmV4aXN0c1N5bmMocCk7IH0gY2F0Y2h7IHJldHVybiBmYWxzZTsgfSB9CgpmdW5jdGlvbiBjb3B5RmlsZShzcmMsIGRlc3QpewogIGlmKCFleGlzdHMoc3JjKSkgcmV0dXJuIGZhbHNlOwogIGVuc3VyZURpcihwYXRoLmRpcm5hbWUoZGVzdCkpOwogIGZzLmNvcHlGaWxlU3luYyhzcmMsIGRlc3QpOwogIHJldHVybiB0cnVlOwp9CgovLyBNYW51YWwgcmVjdXJzaXZlIGRpciBjb3B5IChhdm9pZCBmcy5jcFN5bmMgY3Jhc2ggb24gc29tZSBXaW5kb3dzIHNldHVwcykKZnVuY3Rpb24gY29weURpck1hbnVhbChzcmMsIGRlc3QpewogIGlmKCFleGlzdHMoc3JjKSkgcmV0dXJuIGZhbHNlOwogIGVuc3VyZURpcihkZXN0KTsKICBjb25zdCBlbnRyaWVzID0gZnMucmVhZGRpclN5bmMoc3JjLCB7IHdpdGhGaWxlVHlwZXM6dHJ1ZSB9KTsKICBmb3IoY29uc3QgZW50IG9mIGVudHJpZXMpewogICAgY29uc3QgcyA9IHBhdGguam9pbihzcmMsIGVudC5uYW1lKTsKICAgIGNvbnN0IGQgPSBwYXRoLmpvaW4oZGVzdCwgZW50Lm5hbWUpOwogICAgaWYoZW50LmlzRGlyZWN0b3J5KCkpewogICAgICBjb3B5RGlyTWFudWFsKHMsIGQpOwogICAgfSBlbHNlIGlmKGVudC5pc0ZpbGUoKSl7CiAgICAgIGNvcHlGaWxlKHMsIGQpOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQoKZnVuY3Rpb24gZmluZFZpZGVvQnlDYXIoZm9sZGVyLCBjYXJOYW1lKXsKICBpZighZXhpc3RzKGZvbGRlcikpIHJldHVybiBudWxsOwogIGNvbnN0IGJhc2UgPSBzYWZlTmFtZShjYXJOYW1lKTsKICBjb25zdCBleHRzID0gWycubXA0JywnLm1vdicsJy5tNHYnLCcuYXZpJ107CiAgZm9yKGNvbnN0IGV4dCBvZiBleHRzKXsKICAgIGNvbnN0IHAgPSBwYXRoLmpvaW4oZm9sZGVyLCBiYXNlICsgZXh0KTsKICAgIGlmKGV4aXN0cyhwKSkgcmV0dXJuIHA7CiAgfQogIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMoZm9sZGVyKTsKICBjb25zdCBoaXQgPSBmaWxlcy5maW5kKGYgPT4gZi50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgoYmFzZS50b0xvd2VyQ2FzZSgpKSk7CiAgcmV0dXJuIGhpdCA/IHBhdGguam9pbihmb2xkZXIsIGhpdCkgOiBudWxsOwp9Cgpjb25zdCBST09UID0gX19kaXJuYW1lOwpjb25zdCBPVVQgPSBwYXRoLmpvaW4oUk9PVCwnT1VUUFVUJyk7CmNvbnN0IFBMQU4gPSBwYXRoLmpvaW4oUk9PVCwncGxhbi54bHN4Jyk7CmNvbnN0IEFTU0VUUyA9IHBhdGguam9pbihST09ULCdBU1NFVFMnKTsKCmNvbnNvbGUubG9nKCJST09UOiIsIFJPT1QpOwpjb25zb2xlLmxvZygiUExBTiBleGlzdHM6IiwgZXhpc3RzKFBMQU4pLCAiQVNTRVRTIGV4aXN0czoiLCBleGlzdHMoQVNTRVRTKSk7CgppZighZXhpc3RzKFBMQU4pKXsKICBjb25zb2xlLmVycm9yKCdNaXNzaW5nIHBsYW4ueGxzeCAo2LPZhdmR2Yog2KfZhNi02YrYqiBwbGFuLnhsc3gg2YjYrdi32Ycg2KzZhtioIFJVTi5iYXQpLicpOwogIHByb2Nlc3MuZXhpdCgxKTsKfQppZighZXhpc3RzKEFTU0VUUykpewogIGNvbnNvbGUuZXJyb3IoJ01pc3NpbmcgQVNTRVRTIGZvbGRlciAo2K3YtyDZgdmI2YTYr9ixINin2YTYr9in2KrYpyDYp9mE2K3ZgtmK2YLZiiDYqNin2LPZhSBBU1NFVFMg2KzZhtioIFJVTi5iYXQpLicpOwogIHByb2Nlc3MuZXhpdCgxKTsKfQoKY29uc3Qgd2IgPSBYTFNYLnJlYWRGaWxlKFBMQU4pOwpjb25zdCB3cyA9IHdiLlNoZWV0c1t3Yi5TaGVldE5hbWVzWzBdXTsKY29uc3Qgcm93cyA9IFhMU1gudXRpbHMuc2hlZXRfdG9fanNvbih3cywgeyBkZWZ2YWw6ICcnIH0pOwoKZW5zdXJlRGlyKE9VVCk7Cgpjb25zdCBtaXNzaW5nID0gW107CmNvbnN0IGZpeGVkID0gbmV3IFNldChbJ9in2YTZitmI2YUnLCfYp9mE2YXZhti12KfYqicsJ9mF2YbYp9iz2KjYqSddKTsKY29uc3QgY29udGVudFR5cGVDb2xzID0gcm93cy5sZW5ndGggPyBPYmplY3Qua2V5cyhyb3dzWzBdKS5maWx0ZXIoayA9PiAhZml4ZWQuaGFzKGspKSA6IFtdOwpjb25zb2xlLmxvZygiUm93czoiLCByb3dzLmxlbmd0aCwgIkNvbnRlbnRUeXBlQ29sczoiLCBjb250ZW50VHlwZUNvbHMpOwoKZnVuY3Rpb24gZ3VhcmQoZm4sIHRhZyl7CiAgdHJ5eyByZXR1cm4gZm4oKTsgfSBjYXRjaChlKXsKICAgIG1pc3NpbmcucHVzaChgRVJST1IgJHt0YWd9OiAke2UubWVzc2FnZSB8fCBlfWApOwogICAgcmV0dXJuIGZhbHNlOwogIH0KfQoKZm9yKGNvbnN0IHIgb2Ygcm93cyl7CiAgY29uc3QgZGF5ID0gc2FmZU5hbWUoclsn2KfZhNmK2YjZhSddIHx8ICcnKTsKICBpZighZGF5KSBjb250aW51ZTsKCiAgY29uc3QgcGxhdGZvcm1zID0gc3BsaXRMaXN0KHJbJ9in2YTZhdmG2LXYp9iqJ10gfHwgJycpOwogIGNvbnN0IG5vdGUgPSBzYWZlTmFtZShyWyfZhdmG2KfYs9io2KknXSB8fCAnJyk7CgogIGlmKG5vdGUgPT09ICfYrNmF2LnYqSDZhdio2KfYsdmD2KknKXsKICAgIGNvbnN0IHNyY1Bob3RvcyA9IHBhdGguam9pbihBU1NFVFMsJ9is2YXYudipINmF2KjYp9ix2YPYqScsJ9in2YTYtdmI2LEnKTsKICAgIGNvbnN0IHNyY1N0b3J5ICA9IHBhdGguam9pbihBU1NFVFMsJ9is2YXYudipINmF2KjYp9ix2YPYqScsJ9iz2KrZiNix2YonKTsKCiAgICBjb25zdCBkZXN0QmFzZSAgPSBwYXRoLmpvaW4oT1VULCBkYXksICfYrNmF2LnYqSDZhdio2KfYsdmD2KknKTsKICAgIGNvbnN0IG9rMSA9IGd1YXJkKCgpPT5jb3B5RGlyTWFudWFsKHNyY1Bob3RvcywgcGF0aC5qb2luKGRlc3RCYXNlLCfYp9mE2LXZiNixJykpLCBgWyR7ZGF5fV0g2KzZhdi52Kkg2YXYqNin2LHZg9ipL9in2YTYtdmI2LFgKTsKICAgIGNvbnN0IG9rMiA9IGd1YXJkKCgpPT5jb3B5RGlyTWFudWFsKHNyY1N0b3J5LCAgcGF0aC5qb2luKGRlc3RCYXNlLCfYs9iq2YjYsdmKJykpLCBgWyR7ZGF5fV0g2KzZhdi52Kkg2YXYqNin2LHZg9ipL9iz2KrZiNix2YpgKTsKCiAgICBpZighb2sxKSBtaXNzaW5nLnB1c2goYFske2RheX1dINis2YXYudipINmF2KjYp9ix2YPYqS/Yp9mE2LXZiNixINi62YrYsSDZhdmI2KzZiNiv2Kkg2YHZiiBBU1NFVFNgKTsKICAgIGlmKCFvazIpIG1pc3NpbmcucHVzaChgWyR7ZGF5fV0g2KzZhdi52Kkg2YXYqNin2LHZg9ipL9iz2KrZiNix2Yog2LrZitixINmF2YjYrNmI2K/YqSDZgdmKIEFTU0VUU2ApOwogICAgY29udGludWU7CiAgfQoKICBmb3IoY29uc3QgcCBvZiBwbGF0Zm9ybXMpewogICAgY29uc3QgcGxhdEJhc2UgPSBwYXRoLmpvaW4oT1VULCBkYXksIHNhZmVOYW1lKHApKTsKCiAgICBmb3IoY29uc3QgY29sIG9mIGNvbnRlbnRUeXBlQ29scyl7CiAgICAgIGNvbnN0IHR5cGVOYW1lID0gc2FmZU5hbWUoY29sKTsKICAgICAgY29uc3QgY2FyID0gc2FmZU5hbWUocltjb2xdIHx8ICcnKTsKICAgICAgaWYoIWNhcikgY29udGludWU7CgogICAgICBpZih0eXBlTmFtZS5pbmNsdWRlcygn2KjZiNiz2KonKSB8fCB0eXBlTmFtZS5pbmNsdWRlcygn2LXZiNix2KknKSl7CiAgICAgICAgY29uc3Qgc3JjQ2FyID0gcGF0aC5qb2luKEFTU0VUUywn2KjZiNiz2Kog2LXZiNix2KknLCBjYXIpOwogICAgICAgIGNvbnN0IG9rQSA9IGd1YXJkKCgpPT5jb3B5RGlyTWFudWFsKHBhdGguam9pbihzcmNDYXIsJ9in2YTYtdmI2LEnKSwgIHBhdGguam9pbihwbGF0QmFzZSwn2KjZiNiz2Kog2LXZiNix2KknLCBjYXIsJ9in2YTYtdmI2LEnKSksICBgWyR7ZGF5fV0gJHtwfSDYqNmI2LPYqiDYtdmI2LHYqSAke2Nhcn0v2KfZhNi12YjYsWApOwogICAgICAgIGNvbnN0IG9rQiA9IGd1YXJkKCgpPT5jb3B5RGlyTWFudWFsKHBhdGguam9pbihzcmNDYXIsJ9iz2KrZiNix2YonKSwgcGF0aC5qb2luKHBsYXRCYXNlLCfYqNmI2LPYqiDYtdmI2LHYqScsIGNhciwn2LPYqtmI2LHZiicpKSwgYFske2RheX1dICR7cH0g2KjZiNiz2Kog2LXZiNix2KkgJHtjYXJ9L9iz2KrZiNix2YpgKTsKICAgICAgICBpZighb2tBKSBtaXNzaW5nLnB1c2goYFske2RheX1dICR7cH0g2KjZiNiz2Kog2LXZiNix2KkgKCR7Y2FyfSkv2KfZhNi12YjYsSDZhdi0INmF2YjYrNmI2K/YqWApOwogICAgICAgIGlmKCFva0IpIG1pc3NpbmcucHVzaChgWyR7ZGF5fV0gJHtwfSDYqNmI2LPYqiDYtdmI2LHYqSAoJHtjYXJ9KS/Ys9iq2YjYsdmKINmF2LQg2YXZiNis2YjYr9ipYCk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGlmKHR5cGVOYW1lLmluY2x1ZGVzKCfZhdmI2KfYtdmB2KfYqicpIHx8IHR5cGVOYW1lLmluY2x1ZGVzKCfYsdmK2YQnKSl7CiAgICAgICAgY29uc3Qgc3JjRm9sZGVyID0gcGF0aC5qb2luKEFTU0VUUywn2LHZitmEINmF2YjYp9i12YHYp9iqJyk7CiAgICAgICAgY29uc3Qgc3JjVmlkID0gZmluZFZpZGVvQnlDYXIoc3JjRm9sZGVyLCBjYXIpOwogICAgICAgIGlmKCFzcmNWaWQpewogICAgICAgICAgbWlzc2luZy5wdXNoKGBbJHtkYXl9XSAke3B9INix2YrZhCDZhdmI2KfYtdmB2KfYqiDZgdmK2K/ZitmIICgke2Nhcn0pINmF2LQg2YXZiNis2YjYr2ApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBkZXN0VmlkID0gcGF0aC5qb2luKHBsYXRCYXNlLCfYsdmK2YQg2YXZiNin2LXZgdin2KonLCBwYXRoLmJhc2VuYW1lKHNyY1ZpZCkpOwogICAgICAgICAgZ3VhcmQoKCk9PmNvcHlGaWxlKHNyY1ZpZCwgZGVzdFZpZCksIGBbJHtkYXl9XSAke3B9INix2YrZhCDZhdmI2KfYtdmB2KfYqiBjb3B5ICR7Y2FyfWApOwogICAgICAgIH0KICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgaWYodHlwZU5hbWUuaW5jbHVkZXMoJ9mB2YrYr9mK2YgnKSB8fCB0eXBlTmFtZS5pbmNsdWRlcygn2YLYtdmK2LEnKSl7CiAgICAgICAgY29uc3Qgc3JjRm9sZGVyID0gcGF0aC5qb2luKEFTU0VUUywn2YHZitiv2YrZiCDZgti12YrYsScpOwogICAgICAgIGNvbnN0IHNyY1ZpZCA9IGZpbmRWaWRlb0J5Q2FyKHNyY0ZvbGRlciwgY2FyKTsKICAgICAgICBpZighc3JjVmlkKXsKICAgICAgICAgIG1pc3NpbmcucHVzaChgWyR7ZGF5fV0gJHtwfSDZgdmK2K/ZitmIINmC2LXZitixINmB2YrYr9mK2YggKCR7Y2FyfSkg2YXYtCDZhdmI2KzZiNivYCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGRlc3RWaWQgPSBwYXRoLmpvaW4ocGxhdEJhc2UsJ9mB2YrYr9mK2Ygg2YLYtdmK2LEnLCBwYXRoLmJhc2VuYW1lKHNyY1ZpZCkpOwogICAgICAgICAgZ3VhcmQoKCk9PmNvcHlGaWxlKHNyY1ZpZCwgZGVzdFZpZCksIGBbJHtkYXl9XSAke3B9INmB2YrYr9mK2Ygg2YLYtdmK2LEgY29weSAke2Nhcn1gKTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGNvbnN0IHNyY0N1c3RvbSA9IHBhdGguam9pbihBU1NFVFMsIHR5cGVOYW1lLCBjYXIpOwogICAgICBjb25zdCBvayA9IGd1YXJkKCgpPT5jb3B5RGlyTWFudWFsKHNyY0N1c3RvbSwgcGF0aC5qb2luKHBsYXRCYXNlLCB0eXBlTmFtZSwgY2FyKSksIGBbJHtkYXl9XSAke3B9IGN1c3RvbSAke3R5cGVOYW1lfS8ke2Nhcn1gKTsKICAgICAgaWYoIW9rKSBtaXNzaW5nLnB1c2goYFske2RheX1dICR7cH0g2YbZiNi5ICgke3R5cGVOYW1lfSkgKCR7Y2FyfSkg2YXYtCDZhdmI2KzZiNivINmB2YogQVNTRVRTYCk7CiAgICB9CiAgfQp9CgppZihtaXNzaW5nLmxlbmd0aCl7CiAgY29uc3QgcmVwb3J0UGF0aCA9IHBhdGguam9pbihPVVQsJ19NSVNTSU5HLnR4dCcpOwogIGZzLndyaXRlRmlsZVN5bmMocmVwb3J0UGF0aCwgbWlzc2luZy5qb2luKCdcbicpLCAndXRmOCcpOwogIGNvbnNvbGUubG9nKGBEb25lIOKchSAgQ29waWVkIGZpbGVzLiBNaXNzaW5nIHJlcG9ydDogT1VUUFVUL19NSVNTSU5HLnR4dCAoJHttaXNzaW5nLmxlbmd0aH0pYCk7Cn0gZWxzZSB7CiAgY29uc29sZS5sb2coJ0RvbmUg4pyFICBDb3BpZWQgZmlsZXMgd2l0aCBubyBtaXNzaW5nIGl0ZW1zJyk7Cn0K');

  async function downloadWinZip(){
    if(typeof JSZip === 'undefined'){
      alert('مكتبة JSZip لم تُحمّل. جرّب تعطيل AdBlock ثم حدّث الصفحة.');
      return;
    }
    if(!requireBasics()) return;

    const zip = new JSZip();
    const packageJson = {
      name: "mzj-folder-builder",
      version: "1.0.0",
      private: true,
      type: "commonjs",
      scripts: { start: "node build-folders.js" },
      dependencies: { xlsx: "^0.18.5" }
    };
    const readme = b64ToUtf8('2KrYtNi62YrZhCDYs9mD2LHYqNiqINiu2LfYqSDYp9mE2YbYtNixIChDb3B5IE1vZGUpDQoNCtin2YTZhdi32YTZiNioINiv2KfYrtmEINmG2YHYsyDYp9mE2YXYrNmE2K86DQotIHBsYW4ueGxzeCAgKNin2YTYtNmK2Kog2KjYudivINmF2Kcg2KrZg9iq2Kgg2KPYs9mF2KfYoSDYp9mE2LPZitin2LHYp9iqINmI2KrYrdmB2LgpDQotIEFTU0VUU1wgICAo2YXYrNmE2K8g2KfZhNiv2KfYqtinINin2YTYtNmH2LHZiikNCg0K2KvZhSDYtNi62ZHZhCBSVU4uYmF0DQoNCtin2YTZhtin2KrYrCDYr9in2K7ZhCBPVVRQVVRcWVlZWS1NTS1ERFw8UGxhdGZvcm0+XDxDb250ZW50VHlwZT5cIC4uLg0K2YjZhNmIINmB2Yog2YbZgti1INmH2KrZhNin2YLZiiDYqtmC2LHZitixOiBPVVRQVVRcX01JU1NJTkcudHh0DQo=');
    const bat = b64ToUtf8('QGVjaG8gb2ZmCmNkIC9kICIlfmRwMCIKCmVjaG8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQplY2hvIE1aSiAtIFJVTiAoQ09QWSBNT0RFIHYyKQplY2hvID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCmVjaG8gTm9kZToKY2FsbCBub2RlIC12CmVjaG8uCgpjYWxsIG5wbSBpbnN0YWxsCmVjaG8uCgplY2hvIFJ1bm5pbmcgYnVpbGQtZm9sZGVycy5qcyAuLi4KY2FsbCBub2RlIC0tdHJhY2UtdW5jYXVnaHQgYnVpbGQtZm9sZGVycy5qcwplY2hvIEV4aXRDb2RlPSVlcnJvcmxldmVsJQplY2hvLgpwYXVzZQo=');

    zip.file("package.json", JSON.stringify(packageJson, null, 2));
    zip.file("build-folders.js", builderJs);
    zip.file("RUN.bat", bat);
    zip.file("README_AR.txt", readme);

    const blob = await zip.generateAsync({type:'blob'});
    downloadBlob(blob, 'mzj-folder-builder-win.zip');
  }

  function openPreview(){
    if(!requireBasics()) return;
    const built = buildPlanRows();
    const rows = built.rows;
    const typeCols = built.typeCols;

    $('previewTitle').textContent = `معاينة — ${rows.length} يوم`;

    const headers = ["اليوم","المنصات", ...typeCols, "مناسبة"];
    const thead = `<tr>` + headers.map(h=>`<th>${h}</th>`).join('') + `</tr>`;

    const trs = rows.map(r => {
      return `<tr>` + headers.map(h => `<td>${(r[h] ?? '')}</td>`).join('') + `</tr>`;
    }).join('');

    $('previewBody').innerHTML = `<table>${thead}${trs}</table>`;
    $('modalBack').classList.add('open');
  }

  $('closePreviewBtn').addEventListener('click', ()=> $('modalBack').classList.remove('open'));
  $('modalBack').addEventListener('click', (e)=>{ if(e.target.id==='modalBack') $('modalBack').classList.remove('open'); });

  // IMPORTANT: bind after DOM is ready AND libs are loaded (defer => ok)
  window.addEventListener('load', () => {
    $('downloadExcelBtn').addEventListener('click', downloadExcel);
    $('downloadWinZipBtn').addEventListener('click', downloadWinZip);
    $('previewBtn').addEventListener('click', openPreview);
    console.log('Buttons bound ✅');
  });
})();
</script>
</body>
</html>
