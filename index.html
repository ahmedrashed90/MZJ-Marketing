

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MZJ — مولد خطة النشر</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Libs (defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --brown: rgb(62,36,32);
      --beige: rgb(188,143,116);
      --cream: #fff8ef;
      --line: rgba(62,36,32,.14);
      --text: #2b201e;
      --muted: rgba(43,32,30,.65);
      --shadow: 0 18px 55px rgba(62,36,32,.12);
      --r: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(188,143,116,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(62,36,32,.16), transparent 55%),
        linear-gradient(180deg, #fff3e6, var(--cream));
      overflow-x:hidden;
    }
    .glow{
      position:fixed; inset:-200px; pointer-events:none; z-index:0;
      background: radial-gradient(340px 340px at var(--mx,50%) var(--my,50%), rgba(188,143,116,.22), transparent 60%);
      filter: blur(1px);
    }
    .wrap{position:relative; z-index:1; max-width:1180px; margin:26px auto; padding:0 18px 42px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.45));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--r);
      padding:16px 18px;
      margin-bottom:16px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .logo{
      width:44px; height:44px; border-radius:16px;
      background:
        radial-gradient(80% 80% at 25% 20%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, var(--beige), var(--brown));
      box-shadow: 0 10px 22px rgba(62,36,32,.22);
      flex:0 0 auto;
    }
    .ttl{margin:0; font-weight:900; color:var(--brown); font-size:18px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width:640px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .top{flex-direction:column; align-items:stretch}
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(135deg, rgba(255,255,255,.75), rgba(255,255,255,.42));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px; font-size:16px; font-weight:900; color:var(--brown)}
    .hint{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.6}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    .field{flex:1; min-width:180px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select, input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: rgba(255,255,255,.78);
      font-family: inherit;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(188,143,116,.85); box-shadow: 0 0 0 4px rgba(188,143,116,.18)}
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(62,36,32,.18);
      background: linear-gradient(135deg, rgba(255,255,255,.78), rgba(255,255,255,.55));
      font-family: inherit;
      font-weight:900;
      color:var(--brown);
      box-shadow: 0 10px 26px rgba(62,36,32,.10);
      transition: transform .12s ease, box-shadow .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 14px 30px rgba(62,36,32,.14)}
    .btn.primary{
      border-color: rgba(188,143,116,.55);
      background: linear-gradient(135deg, rgba(188,143,116,.28), rgba(255,255,255,.70));
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .picker{display:none; margin-top:12px; border:1px solid rgba(62,36,32,.16); background: rgba(255,255,255,.55); border-radius: 18px; padding:12px;}
    .picker.open{display:block}
    .pickerHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .pickerHead b{color:var(--brown)}
    .list{max-height: 240px; overflow:auto; padding:6px; border-radius: 14px; border:1px dashed rgba(62,36,32,.18); background: rgba(255,255,255,.55);}
    .item{display:flex; align-items:center; justify-content:space-between; padding:10px 10px; border-radius: 12px; background: rgba(255,255,255,.65); border:1px solid rgba(62,36,32,.10); margin-bottom:8px;}
    .chipWrap{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 999px; background: rgba(188,143,116,.20); border:1px solid rgba(188,143,116,.35); color:var(--brown); font-weight:900; font-size:13px;}
    .chip button{border:none; background:transparent; cursor:pointer; color:rgba(62,36,32,.75); font-weight:900; font-size:16px; line-height:1}
    .mini{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;}
    .toast{
      position: fixed; left:18px; bottom:18px; z-index:10;
      padding:12px 14px; border-radius: 14px;
      border:1px solid rgba(62,36,32,.16);
      background: rgba(255,255,255,.88);
      box-shadow: 0 16px 40px rgba(62,36,32,.14);
      color:var(--brown);
      font-weight:900;
      display:none;
      max-width:min(420px, calc(100vw - 36px));
    }
    /* preview modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(20,10,8,.35);
      display:none; align-items:center; justify-content:center; padding:18px; z-index:20;
      backdrop-filter: blur(2px);
    }
    .modalBack.open{display:flex}
    .modal{
      width:min(980px, 100%);
      max-height:min(85vh, 760px);
      overflow:auto;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(62,36,32,.18);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.18);
      padding:14px;
    }
    .modalTop{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .modalTop b{color:var(--brown); font-size:15px}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid rgba(62,36,32,.16)}
    th, td{padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(62,36,32,.10); vertical-align:top}
    th{background: rgba(188,143,116,.18); color:var(--brown); font-weight:900; position:sticky; top:0}
    tr:last-child td{border-bottom:none}
    td{background: rgba(255,255,255,.65)}
  </style>
</head>

<body>
  <div class="glow" id="glow"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <p class="ttl">MZJ — مولد خطة النشر</p>
          <p class="sub">اختار الشهر والسنة وعدد أيام النشر والمنصات وأنواع المحتوى. بعدين حمّل الشيت والسكربت (ويندوز) لإنشاء الفولدرات تلقائيًا على جهازك.</p>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>إعدادات الفترة</h2>
        <p class="hint">اختار الشهر والسنة وعدد أيام النشر. يوم الجمعة يولّد تلقائيًا "جمعة مباركة".</p>
        <div class="row">
          <div class="field">
            <label>السنة</label>
            <select id="yearSel"></select>
          </div>
          <div class="field">
            <label>الشهر</label>
            <select id="monthSel"></select>
          </div>
          <div class="field">
            <label>عدد أيام النشر</label>
            <input id="publishDays" inputmode="numeric" placeholder="مثال: 13" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>مخرجات التحميل</h2>
        <p class="hint">الشيت فيه (اليوم/المنصات + عمود لكل نوع محتوى + مناسبة). السكربت (ويندوز) يقرأ الشيت ويعمل الفولدرات داخل OUTPUT.</p>
        <div class="row">
          <button class="btn primary" id="downloadExcelBtn" type="button">تحميل الشيت (Excel)</button>
          <button class="btn" id="downloadWinZipBtn" type="button">تحميل سكربت ويندوز (ZIP)</button>
          <button class="btn" id="previewBtn" type="button">معاينة</button>
        </div>
        <div class="mini">
          <div class="field" style="min-width:320px">
            <label>ملاحظة التشغيل</label>
            <input disabled value="فك الـ ZIP → سمّي الشيت plan.xlsx → شغّل RUN.bat → المخرجات داخل OUTPUT" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>المنصات</h2>
        <p class="hint">اختار المنصات مرة واحدة، وكل منصة تختارها تتحول Chip وتختفي من القائمة.</p>

        <button class="btn" type="button" id="openPlatformsBtn">اختيار المنصات</button>

        <div class="picker" id="platformPicker">
          <div class="pickerHead">
            <b>اختيار المنصات</b>
            <button class="btn" type="button" id="closePlatformsBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة منصة مخصصة</label>
              <input id="platformCustom" placeholder="مثال: Threads" />
            </div>
            <button class="btn" type="button" id="addPlatformBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>المنصات المتاحة</label>
            <div class="list" id="platformList"></div>
          </div>
        </div>

        <div class="chipWrap" id="platformChips"></div>
      </div>

      <div class="card">
        <h2>أنواع المحتوى</h2>
        <p class="hint">اختار أنواع المحتوى مرة واحدة (بوست صورة/ريل مواصفات/فيديو قصير… إلخ).</p>

        <button class="btn" type="button" id="openTypesBtn">اختيار أنواع المحتوى</button>

        <div class="picker" id="typePicker">
          <div class="pickerHead">
            <b>اختيار أنواع المحتوى</b>
            <button class="btn" type="button" id="closeTypesBtn">تم</button>
          </div>

          <div class="mini">
            <div class="field">
              <label>إضافة نوع مخصص</label>
              <input id="typeCustom" placeholder="مثال: لايف" />
            </div>
            <button class="btn" type="button" id="addTypeBtn">إضافة</button>
          </div>

          <div style="margin-top:10px">
            <label>الأنواع المتاحة</label>
            <div class="list" id="typeList"></div>
          </div>
        </div>

        <div class="chipWrap" id="typeChips"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <b id="previewTitle">معاينة</b>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn" id="closePreviewBtn" type="button">إغلاق</button>
        </div>
      </div>
      <div id="previewBody"></div>
    </div>
  </div>

<script>
(() => {
  const glow = document.getElementById('glow');
  window.addEventListener('mousemove', (e)=>{
    const x = (e.clientX / window.innerWidth) * 100;
    const y = (e.clientY / window.innerHeight) * 100;
    glow.style.setProperty('--mx', x + '%');
    glow.style.setProperty('--my', y + '%');
  });

  const $ = (id)=>document.getElementById(id);
  const toastEl = $('toast');
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toastEl.style.display='none', 2200);
  }

  // Period
  const yearSel = $('yearSel');
  const monthSel = $('monthSel');
  const publishDays = $('publishDays');

  const monthsAr = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
  const now = new Date();
  const yNow = now.getFullYear();

  for(let y=yNow-1; y<=yNow+3; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    if(y===yNow) opt.selected = true;
    yearSel.appendChild(opt);
  }
  monthsAr.forEach((m, i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = m;
    if(i===now.getMonth()) opt.selected = true;
    monthSel.appendChild(opt);
  });

  // Pickers
  const DEFAULT_PLATFORMS = ['Instagram','TikTok','Snapchat','Facebook','X (Twitter)'];
  const DEFAULT_TYPES = ['بوست صورة','ريل مواصفات','فيديو قصير'];

  let availablePlatforms = [...DEFAULT_PLATFORMS];
  let selectedPlatforms = [];

  let availableTypes = [...DEFAULT_TYPES];
  let selectedTypes = [];

  function renderList(listEl, items, onAdd){
    listEl.innerHTML = '';
    if(items.length===0){
      listEl.innerHTML = '<div style="padding:10px;color:rgba(43,32,30,.6)">مفيش عناصر متاحة</div>';
      return;
    }
    items.forEach(name=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `<span style="font-weight:900;color:var(--brown)">${name}</span>
                       <button class="btn" type="button" style="padding:8px 10px">إضافة</button>`;
      row.querySelector('button').addEventListener('click', ()=>onAdd(name));
      listEl.appendChild(row);
    });
  }

  function renderChips(chipsEl, selectedArr, onRemove){
    chipsEl.innerHTML = '';
    selectedArr.forEach(name=>{
      const c = document.createElement('span');
      c.className = 'chip';
      c.innerHTML = `<span>${name}</span><button type="button" aria-label="remove">×</button>`;
      c.querySelector('button').addEventListener('click', ()=>onRemove(name));
      chipsEl.appendChild(c);
    });
  }

  function pickPlatform(name){
    selectedPlatforms.push(name);
    availablePlatforms = availablePlatforms.filter(x=>x!==name);
    renderAllPlatforms();
  }
  function removePlatform(name){
    selectedPlatforms = selectedPlatforms.filter(x=>x!==name);
    if(!availablePlatforms.includes(name)) availablePlatforms.push(name);
    availablePlatforms.sort((a,b)=>a.localeCompare(b));
    renderAllPlatforms();
  }
  function renderAllPlatforms(){
    renderList($('platformList'), availablePlatforms, pickPlatform);
    renderChips($('platformChips'), selectedPlatforms, removePlatform);
  }

  function pickType(name){
    selectedTypes.push(name);
    availableTypes = availableTypes.filter(x=>x!==name);
    renderAllTypes();
  }
  function removeType(name){
    selectedTypes = selectedTypes.filter(x=>x!==name);
    if(!availableTypes.includes(name)) availableTypes.push(name);
    availableTypes.sort((a,b)=>a.localeCompare(b));
    renderAllTypes();
  }
  function renderAllTypes(){
    renderList($('typeList'), availableTypes, pickType);
    renderChips($('typeChips'), selectedTypes, removeType);
  }

  renderAllPlatforms();
  renderAllTypes();

  $('openPlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.add('open'));
  $('closePlatformsBtn').addEventListener('click', ()=> $('platformPicker').classList.remove('open'));
  $('openTypesBtn').addEventListener('click', ()=> $('typePicker').classList.add('open'));
  $('closeTypesBtn').addEventListener('click', ()=> $('typePicker').classList.remove('open'));

  $('addPlatformBtn').addEventListener('click', ()=>{
    const v = ($('platformCustom').value||'').trim();
    if(!v) return;
    if(selectedPlatforms.includes(v) || availablePlatforms.includes(v)) { toast('الموجود بالفعل'); return; }
    availablePlatforms.unshift(v);
    $('platformCustom').value = '';
    renderAllPlatforms();
  });

  $('addTypeBtn').addEventListener('click', ()=>{
    const v = ($('typeCustom').value||'').trim();
    if(!v) return;
    if(selectedTypes.includes(v) || availableTypes.includes(v)) { toast('الموجود بالفعل'); return; }
    availableTypes.unshift(v);
    $('typeCustom').value = '';
    renderAllTypes();
  });

  function buildPlanRows(){
    const year = Number(yearSel.value);
    const monthIndex0 = Number(monthSel.value);
    const daysN = Math.max(0, Number((publishDays.value||'').trim()) || 0);

    const typeCols = selectedTypes.slice(); // column names as-is
    const rows = [];

    // Iterate calendar days until we collect daysN rows (Friday INCLUDED in the count)
    const daysInMonth = new Date(year, monthIndex0 + 1, 0).getDate();
    let added = 0;

    for(let d=1; d<=daysInMonth && added < daysN; d++){
      const date = new Date(year, monthIndex0, d);

      // Local ISO (avoid UTC shift that can turn 2026-01-01 into 2025-12-31)
      const iso =
        date.getFullYear() + '-' +
        String(date.getMonth() + 1).padStart(2, '0') + '-' +
        String(date.getDate()).padStart(2, '0');

      const isFriday = date.getDay() === 5;

      const row = {
        "اليوم": iso,
        "المنصات": selectedPlatforms.join(', ')
      };

      // one column per content type (you will fill car names later)
      typeCols.forEach(t => { row[t] = ""; });

      // Friday marker (folders: جمعة مباركة -> صور + ستوري)
      row["مناسبة"] = isFriday ? "جمعة مباركة" : "";

      rows.push(row);
      added++;
    }

    return { rows, typeCols };
  }




  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }

  function requireBasics(){
    if(!publishDays.value.trim()){
      toast('اكتب عدد أيام النشر');
      return false;
    }
    if(selectedPlatforms.length === 0){
      toast('اختار منصة واحدة على الأقل');
      return false;
    }
    if(selectedTypes.length === 0){
      toast('اختار نوع محتوى واحد على الأقل');
      return false;
    }
    return true;
  }

  async function downloadExcel(){
    if(typeof XLSX === 'undefined'){
      alert('مكتبة XLSX لم تُحمّل. جرّب تعطيل AdBlock ثم حدّث الصفحة.');
      return;
    }
    if(!requireBasics()) return;

    const built = buildPlanRows();
    const rows = built.rows;
    const typeCols = built.typeCols;

    const headers = ["اليوم","المنصات", ...typeCols, "مناسبة"];
    const ws = XLSX.utils.json_to_sheet(rows, { header: headers });

    // widths
    const cols = [{wch:14},{wch:44}];
    for(let i=0;i<typeCols.length;i++) cols.push({wch:26});
    cols.push({wch:18}); // مناسبة
    ws['!cols'] = cols;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Plan');

    const year = Number(yearSel.value);
    const monthNum = String(Number(monthSel.value)+1).padStart(2,'0');
    const file = `MZJ-Plan-${year}-${monthNum}.xlsx`;

    const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
    downloadBlob(new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), file);
  }

  const builderJs = `const fs = require('fs');
const path = require('path');
const XLSX = require('xlsx');

function safeName(s){
  return String(s||'').trim().replace(/[\\/:*?"<>|]/g,'-').replace(/\s+/g,' ').trim();
}
function ensureDir(p){ if(!fs.existsSync(p)) fs.mkdirSync(p,{recursive:true}); }
function splitList(s){ return String(s||'').split(',').map(x=>x.trim()).filter(Boolean); }

// Map column name (content type) to folder(s)
function typeFolders(typeCol){
  const t = String(typeCol||'').toLowerCase();
  if(t.includes('بوست') || t.includes('صورة')) return ['صور','ستوري'];
  if(t.includes('مواصفات') || t.includes('ريل')) return ['ريل مواصفات'];
  if(t.includes('فيديو') || t.includes('قصير')) return ['فيديو قصير'];
  return [safeName(typeCol)];
}

const root = path.join(__dirname,'OUTPUT');
const planPath = path.join(__dirname,'plan.xlsx');

if(!fs.existsSync(planPath)){
  console.error('Missing plan.xlsx (ضع ملف الشيت باسم plan.xlsx داخل نفس المجلد).');
  process.exit(1);
}

const wb = XLSX.readFile(planPath);
const ws = wb.Sheets[wb.SheetNames[0]];
const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

ensureDir(root);

for(const r of rows){
  const day = safeName(r['اليوم'] || '');
  if(!day) continue;

  const platforms = splitList(r['المنصات'] || '');
  const note = safeName(r['مناسبة'] || '');

  // Friday special
  if(note === 'جمعة مباركة'){
    const base = path.join(root, day, 'جمعة مباركة');
    ensureDir(path.join(base,'صور'));
    ensureDir(path.join(base,'ستوري'));
    continue;
  }

  // For each content type column (any column except fixed ones)
  const fixed = new Set(['اليوم','المنصات','مناسبة']);
  const contentTypeCols = Object.keys(r).filter(k => !fixed.has(k));

  for(const p of platforms){
    const platBase = path.join(root, day, safeName(p));
    for(const col of contentTypeCols){
      const car = safeName(r[col] || '') || 'اسم السيارة';
      const folders = typeFolders(col);
      for(const f of folders){
        const target = path.join(platBase, f, car);
        ensureDir(target);
      }
    }
  }
}

console.log('Done ✅  Created folders in OUTPUT');`;

  async function downloadWinZip(){
    if(typeof JSZip === 'undefined'){
      alert('مكتبة JSZip لم تُحمّل. جرّب تعطيل AdBlock ثم حدّث الصفحة.');
      return;
    }
    if(!requireBasics()) return;

    const zip = new JSZip();
    const packageJson = {
      name: "mzj-folder-builder",
      version: "1.0.0",
      private: true,
      type: "commonjs",
      scripts: { start: "node build-folders.js" },
      dependencies: { xlsx: "^0.18.5" }
    };
    const readme = `تشغيل سكربت إنشاء الفولدرات (ويندوز)\r\n\r\n1) فك الضغط\r\n2) حمّل الشيت من الصفحة وسمّه plan.xlsx وحطه داخل نفس فولدر RUN.bat\r\n3) دبل كليك RUN.bat\r\n\r\nالمخرجات:\r\nOUTPUT\\YYYY-MM-DD\\Platform\\(صور/ستوري/ريل مواصفات/فيديو قصير)\\اسم السيارة\r\nويوم الجمعة:\r\nOUTPUT\\YYYY-MM-DD\\جمعة مباركة\\(صور/ستوري)\r\n`;
    const bat = `@echo off\r\nsetlocal\r\ncd /d %~dp0\r\necho Installing dependencies...\r\nnpm install\r\nif %errorlevel% neq 0 (\r\n  echo npm install failed.\r\n  pause\r\n  exit /b 1\r\n)\r\necho Running...\r\nnode build-folders.js\r\npause\r\n`;

    zip.file("package.json", JSON.stringify(packageJson, null, 2));
    zip.file("build-folders.js", builderJs);
    zip.file("RUN.bat", bat);
    zip.file("README_AR.txt", readme);

    const blob = await zip.generateAsync({type:'blob'});
    downloadBlob(blob, 'mzj-folder-builder-win.zip');
  }

  function openPreview(){
    if(!requireBasics()) return;
    const built = buildPlanRows();
    const rows = built.rows;
    const typeCols = built.typeCols;

    $('previewTitle').textContent = `معاينة — ${rows.length} يوم`;

    const headers = ["اليوم","المنصات", ...typeCols, "مناسبة"];
    const thead = `<tr>` + headers.map(h=>`<th>${h}</th>`).join('') + `</tr>`;

    const trs = rows.map(r => {
      return `<tr>` + headers.map(h => `<td>${(r[h] ?? '')}</td>`).join('') + `</tr>`;
    }).join('');

    $('previewBody').innerHTML = `<table>${thead}${trs}</table>`;
    $('modalBack').classList.add('open');
  }

  $('closePreviewBtn').addEventListener('click', ()=> $('modalBack').classList.remove('open'));
  $('modalBack').addEventListener('click', (e)=>{ if(e.target.id==='modalBack') $('modalBack').classList.remove('open'); });

  // IMPORTANT: bind after DOM is ready AND libs are loaded (defer => ok)
  window.addEventListener('load', () => {
    $('downloadExcelBtn').addEventListener('click', downloadExcel);
    $('downloadWinZipBtn').addEventListener('click', downloadWinZip);
    $('previewBtn').addEventListener('click', openPreview);
    console.log('Buttons bound ✅');
  });
})();
</script>
</body>
</html>
